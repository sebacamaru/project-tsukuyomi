const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./EggReveal-DSKJK3-U.js","./assetRegistry-B3bpuhkC.js","./EggReveal-CBOrKqUU.css"])))=>i.map(i=>d[i]);
import{a as e,c as t,f as n,i as r,l as i,o as a,r as o,s,t as c}from"./index-zi4sCZYj.js";import{t as l}from"./Scene-DWeb6wuE.js";import{t as u}from"./MessageBox-B-ocjRWL.js";var d=`<div class="professor">
    <div class="sprite"></div>
</div>
`,f=`/api`;const p={async getQuests(){return(await fetch(`${f}/quests`,{headers:r()})).json()},async getQuest(e){return(await fetch(`${f}/quests/${e}`,{headers:r()})).json()},async checkUsername(e,t=null){let n=`${f}/users/check-username/${encodeURIComponent(e)}`;return t&&(n+=`?excludeUserId=${t}`),(await(await fetch(n,{headers:r()})).json()).available},async setUsername(e,t){let n=await fetch(`${f}/users/${e}/username`,{method:`PUT`,headers:r(),body:JSON.stringify({username:t})});return n.ok?{success:!0,user:await n.json()}:{success:!1,error:(await n.json()).error}},async completeQuest(e,t=0){let n=await fetch(`${f}/users/${e}/complete-quest`,{method:`POST`,headers:r(),body:JSON.stringify({delayMinutes:t})});return n.ok?{success:!0,...await n.json()}:{success:!1,error:(await n.json()).error}},async getUser(e){return(await fetch(`${f}/users/${e}`,{headers:r()})).json()}},m={egg_reveal:()=>n(()=>import(`./EggReveal-DSKJK3-U.js`),__vite__mapDeps([0,1,2]),import.meta.url)};var h=(e,t,n)=>{let r=t.lastIndexOf(`?`),i=e[r===-1||r<t.lastIndexOf(`/`)?t:t.slice(0,r)];return i?typeof i==`function`?i():Promise.resolve(i):new Promise((e,r)=>{(typeof queueMicrotask==`function`?queueMicrotask:setTimeout)(r.bind(null,Error(`Unknown variable dynamic import: `+t+(t.split(`/`).length===n?``:`. Note that variables only represent file names one level deep.`))))})};async function g(e){return(await h({"../data/quests/onboarding.json":()=>n(()=>import(`./onboarding-BNO_lPws.js`),[],import.meta.url),"../data/quests/set_username.json":()=>n(()=>import(`./set_username-BjCYzjqk.js`),[],import.meta.url)},`../data/quests/${e}.json`,4)).default}var _=class{constructor(e,t){this.questData=e,this.dialogues=e.dialogues,this.scene=t,this.dialogueMap=new Map,this.dialogues.forEach(e=>{this.dialogueMap.set(e.id,e)}),this.context={}}async run(){let e=this.dialogues[0].id;for(;e;){let t=this.dialogueMap.get(e);if(!t){console.error(`Dialogue not found: ${e}`);break}e=await this.processDialogue(t)}}async processDialogue(e){if(e.text){let t=this.replaceVariables(e.text);if(e.options&&e.options.length>0){let n=await u.show({speaker:e.speaker,text:t,options:e.options.map(e=>({text:e.text,value:e.value,icon:e.icon}))});return n&&(e.options.find(e=>e.value===n.value)?.next||e.next)||null}else await u.alert(t,e.speaker)}if(e.action){let t=await this.handleAction(e);if(e.action===`complete_quest`)return null;if(!t)return e.next||null}return e.next||null}async handleAction(e){let t=e.action;if(m[t])try{let n=await m[t](),r=n[Object.keys(n)[0]];return await new r({runner:this,context:this.context,store:i,scene:this.scene},e.actionData).show()}catch(e){return console.error(`Error loading action "${t}":`,e),!0}switch(t){case`input_username`:return await this.handleInputUsername();case`create_monster`:return await this.handleCreateMonster(e.actionData);case`complete_quest`:return await this.handleCompleteQuest();default:return console.warn(`Unknown action: ${t}`),!0}}async handleInputUsername(){let e=null,t=!1;for(;!t;){if(e=await this.showUsernameInput(`Escribe tu nombre:`),!e)return!1;if(e.length<3){await u.alert(`El nombre debe tener al menos 3 caracteres.`,`Profesor Cacho`);continue}if(e.length>20){await u.alert(`El nombre no puede tener mas de 20 caracteres.`,`Profesor Cacho`);continue}if(!/^[a-zA-Z0-9_]+$/.test(e)){await u.alert(`El nombre solo puede contener letras, numeros y guiones bajos.`,`Profesor Cacho`);continue}if(!await p.checkUsername(e,i.user.id)){await u.alert(`Ese nombre ya esta en uso. Intenta con otro.`,`Profesor Cacho`);continue}(await p.setUsername(i.user.id,e)).success?(i.user.username=e,o.updateSession(),this.context.username=e,t=!0):await u.alert(`Hubo un error al guardar el nombre. Intenta de nuevo.`,`Profesor Cacho`)}return!0}async showUsernameInput(e=``){return new Promise(t=>{let n=i.user?.username||``,r=e?`<p class="username-input-box__text">${e}</p>`:``,a=document.createElement(`div`);a.className=`message-box-overlay message-box-overlay--centered`,a.innerHTML=`
        <div class="message-box username-input-box">
          <div class="username-input-container">
            ${r}
            <input type="text" class="input" value="${n}" maxlength="20" placeholder="Tu nombre..." />
            <button class="button">Confirmar</button>
          </div>
        </div>
      `;let o=a.querySelector(`.input`),s=a.querySelector(`.button`),c=()=>{a.classList.remove(`active`),setTimeout(()=>a.remove(),300)},l=()=>{let e=o.value.trim();e&&(c(),t(e))};s.addEventListener(`click`,l),o.addEventListener(`keydown`,e=>{e.key===`Enter`&&l()}),document.body.appendChild(a),requestAnimationFrame(()=>{a.classList.add(`active`),o.focus(),o.select()})})}async handleCreateMonster(e){return console.log(`Creating monster:`,e),this.context.starterType=e?.type,!0}parseDelay(){let e=this.questData.nextQuestDelay;if(!e)return 0;let t=this.questData.debug===!0?1:60;if(typeof e==`number`)return e*t;if(typeof e==`string`&&e.includes(`-`)){let[n,r]=e.split(`-`).map(Number),i=Math.random()*(r-n)+n;return Math.round(i*t)}return 0}async handleCompleteQuest(){let n=this.parseDelay(),r=await p.completeQuest(i.user.id,n);return r.success?(await Promise.all([t.getUserEggs(),s.getUserCandies(),a.getUserStones(),e.getUserChigos()]),i.user.current_quest_code=r.user.current_quest_code,i.user.next_quest_available_at=r.user.next_quest_available_at,i.user.gold=r.user.gold,o.updateSession(),c&&(c.updateProfessorBadge(),c.refreshNavbar()),!0):(console.error(`Failed to complete quest:`,r),!1)}async showRewards(e){let t=``;if(e.gold>0&&(t+=`+${e.gold} oro\n`),e.items?.length>0)for(let n of e.items)t+=`+${n.quantity}x ${n.name}\n`;t&&await u.alert(t.trim(),`Recompensas`)}replaceVariables(e){return e.replace(/\{(\w+)\}/g,(e,t)=>this.context[t]===void 0?i.user&&i.user[t]!==void 0?i.user[t]:e:this.context[t])}},v=class extends l{constructor(){super(),this.backgroundClass=`professor-background`}async getHTML(){return d}async onEnterComplete(){await this.checkAndRunQuests()}async checkAndRunQuests(){let e=i.user;this.enterCutsceneMode(),await this.delay(500),e=await p.getUser(e.id),i.user=e;let t=e.current_quest_code;if(!t){await u.alert(`Hola de nuevo, ${e.username}! Que bueno verte por aqui.`,`Profesor Cacho`),this.exitCutsceneMode();return}if(e.next_quest_available_at&&Math.floor(Date.now()/1e3)<e.next_quest_available_at){await u.alert(`Hola, ${e.username}! Vuelve cuando quieras.`,`Profesor Cacho`),this.exitCutsceneMode();return}let n=await p.getQuest(t);if(!n||n.scene!==`professor`){await u.alert(`Hola, ${e.username}! Vuelve cuando quieras.`,`Profesor Cacho`),this.exitCutsceneMode();return}let r=await g(t);await new _(r,this).run(),this.exitCutsceneMode();let a=r.nextQuestDelay&&r.nextQuestDelay>0;if(r.autoNextQuest!==!1&&!a){let t=await p.getUser(e.id);if(i.user=t,t.current_quest_code){let e=await p.getQuest(t.current_quest_code);e&&e.scene===`professor`&&await this.checkAndRunQuests()}}}async initUI(){}};export{v as ProfessorScene};