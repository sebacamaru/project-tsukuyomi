import{i as e,r as t,s as n}from"./index-Do9XzL4n.js";import{t as r}from"./Scene-Bx4WwdoU.js";var i=`<div class="professor">
    <div class="sprite"></div>
</div>
`,a=class e{static isActive=!1;constructor(e){this.speaker=e.speaker||``,this.text=e.text||``,this.options=e.options||[],this.onSelect=e.onSelect||(()=>{}),this.onClose=e.onClose||(()=>{}),this.typewriterSpeed=e.typewriterSpeed||30,this.enableTypewriter=e.enableTypewriter!==!1,this.closable=e.closable!==!1,this.element=null,this.textElement=null,this.typewriterTimeout=null,this.isTyping=!1,this.fullText=this.text,this.currentCharIndex=0,this.resolvePromise=null}render(){let e=document.createElement(`div`);return e.className=`message-box-overlay`,e.innerHTML=`
      <div class="message-box">
        <div class="message-box__content">
          ${this.speaker?`
            <div class="message-box__speaker">${this.speaker}</div>
          `:``}
          <div class="message-box__text"></div>
          ${this.options.length>0?`
            <div class="message-box__options">
              ${this.options.map((e,t)=>`
                <button class="message-box__option" data-index="${t}" data-value="${e.value||e.text}">
                  ${e.icon?`<span class="option-icon">${e.icon}</span>`:``}
                  <span class="option-text">${e.text}</span>
                </button>
              `).join(``)}
            </div>
          `:``}
          ${this.closable&&this.options.length===0?`
            <div class="message-box__close-hint">
              <span>Tap o [Enter] para continuar</span>
            </div>
          `:``}
        </div>
      </div>
    `,this.element=e,this.textElement=e.querySelector(`.message-box__text`),this._attachEvents(),e}_attachEvents(){this.element.querySelectorAll(`.message-box__option`).forEach(e=>{e.addEventListener(`click`,t=>{if(this.isTyping){this._skipTypewriter();return}let n=e.dataset.value,r=parseInt(e.dataset.index);this._handleSelect(n,r)})}),this.closable&&this.options.length===0&&(this.element.addEventListener(`click`,e=>{this.isTyping?this._skipTypewriter():(e.target.classList.contains(`message-box-overlay`)||e.target.closest(`.message-box__text`))&&this._handleClose()}),this._keyHandler=e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),this.isTyping?this._skipTypewriter():this._handleClose())},document.addEventListener(`keydown`,this._keyHandler)),this.textElement&&this.textElement.addEventListener(`click`,()=>{this.isTyping&&this._skipTypewriter()})}async show(){return e.isActive?new Promise(e=>e(null)):new Promise(t=>{this.resolvePromise=t,e.isActive=!0,this.element||this.render(),document.body.appendChild(this.element),requestAnimationFrame(()=>{this.element.classList.add(`active`)}),this.enableTypewriter?this._startTypewriter():(this.textElement.textContent=this.fullText,this._showOptions())})}_startTypewriter(){this.isTyping=!0,this.currentCharIndex=0,this.textElement.textContent=``;let e=()=>{this.currentCharIndex<this.fullText.length?(this.textElement.textContent+=this.fullText[this.currentCharIndex],this.currentCharIndex++,this.typewriterTimeout=setTimeout(e,this.typewriterSpeed)):(this.isTyping=!1,this._showOptions())};e()}_skipTypewriter(){this.typewriterTimeout&&clearTimeout(this.typewriterTimeout),this.isTyping=!1,this.textElement.textContent=this.fullText,this._showOptions()}_showOptions(){let e=this.element.querySelector(`.message-box__options`);e&&e.classList.add(`visible`)}_handleSelect(e,t){let n=this.options[t];this.onSelect&&this.onSelect(e,n,t),this.hide(),this.resolvePromise&&this.resolvePromise({value:e,option:n,index:t})}_handleClose(){this.onClose&&this.onClose(),this.hide(),this.resolvePromise&&this.resolvePromise(null)}hide(){e.isActive=!1,this.typewriterTimeout&&clearTimeout(this.typewriterTimeout),this._keyHandler&&document.removeEventListener(`keydown`,this._keyHandler),this.element.classList.remove(`active`),setTimeout(()=>{this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)},300)}static async show(t){return await new e(t).show()}static async alert(t,n=``){return await e.show({text:t,speaker:n,options:[],closable:!0})}static async confirm(t,n=``){let r=await e.show({text:t,speaker:n,options:[{text:`SÃ­`,value:!0},{text:`No`,value:!1}]});return r?r.value:!1}},o=`/api`;const s={async getQuests(){return(await fetch(`${o}/quests`,{headers:t()})).json()},async getQuest(e){return(await fetch(`${o}/quests/${e}`,{headers:t()})).json()},async checkUsername(e){return(await(await fetch(`${o}/users/check-username/${encodeURIComponent(e)}`,{headers:t()})).json()).available},async setUsername(e,n){let r=await fetch(`${o}/users/${e}/username`,{method:`PUT`,headers:t(),body:JSON.stringify({username:n})});return r.ok?{success:!0,user:await r.json()}:{success:!1,error:(await r.json()).error}},async completeQuest(e){let n=await fetch(`${o}/users/${e}/complete-quest`,{method:`POST`,headers:t()});return n.ok?{success:!0,...await n.json()}:{success:!1,error:(await n.json()).error}},async getUser(e){return(await fetch(`${o}/users/${e}`,{headers:t()})).json()}};var c=(e,t,n)=>{let r=t.lastIndexOf(`?`),i=e[r===-1||r<t.lastIndexOf(`/`)?t:t.slice(0,r)];return i?typeof i==`function`?i():Promise.resolve(i):new Promise((e,r)=>{(typeof queueMicrotask==`function`?queueMicrotask:setTimeout)(r.bind(null,Error(`Unknown variable dynamic import: `+t+(t.split(`/`).length===n?``:`. Note that variables only represent file names one level deep.`))))})};async function l(e){return(await c({"../data/quests/onboarding.json":()=>n(()=>import(`./onboarding-BLbSFaQl.js`),[],import.meta.url),"../data/quests/set_username.json":()=>n(()=>import(`./set_username-Cb5aBPae.js`),[],import.meta.url)},`../data/quests/${e}.json`,4)).default}var u=class{constructor(e,t){this.questData=e,this.dialogues=e.dialogues,this.scene=t,this.dialogueMap=new Map,this.dialogues.forEach(e=>{this.dialogueMap.set(e.id,e)}),this.context={}}async run(){let e=this.dialogues[0].id;for(;e;){let t=this.dialogueMap.get(e);if(!t){console.error(`Dialogue not found: ${e}`);break}e=await this.processDialogue(t)}}async processDialogue(e){if(e.action){let t=await this.handleAction(e);if(e.action===`complete_quest`)return null;if(!t&&!e.text)return e.next||null}if(e.text){let t=this.replaceVariables(e.text);if(e.options&&e.options.length>0){let n=await a.show({speaker:e.speaker,text:t,options:e.options.map(e=>({text:e.text,value:e.value,icon:e.icon}))});return n&&(e.options.find(e=>e.value===n.value)?.next||e.next)||null}else await a.alert(t,e.speaker)}return e.next||null}async handleAction(e){switch(e.action){case`input_username`:return await this.handleInputUsername();case`create_monster`:return await this.handleCreateMonster(e.actionData);case`complete_quest`:return await this.handleCompleteQuest();default:return console.warn(`Unknown action: ${e.action}`),!0}}async handleInputUsername(){let t=null,n=!1;for(;!n;){if(t=await this.showUsernameInput(),!t)return!1;if(t.length<3){await a.alert(`El nombre debe tener al menos 3 caracteres.`,`Profesor Cacho`);continue}if(t.length>20){await a.alert(`El nombre no puede tener mas de 20 caracteres.`,`Profesor Cacho`);continue}if(!/^[a-zA-Z0-9_]+$/.test(t)){await a.alert(`El nombre solo puede contener letras, numeros y guiones bajos.`,`Profesor Cacho`);continue}if(!await s.checkUsername(t)){await a.alert(`Ese nombre ya esta en uso. Intenta con otro.`,`Profesor Cacho`);continue}(await s.setUsername(e.user.id,t)).success?(e.user.username=t,this.context.username=t,n=!0):await a.alert(`Hubo un error al guardar el nombre. Intenta de nuevo.`,`Profesor Cacho`)}return!0}async showUsernameInput(){return new Promise(e=>{let t=document.createElement(`div`);t.className=`message-box-overlay active`,t.innerHTML=`
        <div class="message-box">
          <div class="message-box__content">
            <div class="message-box__speaker">Profesor Cacho</div>
            <div class="message-box__text">Escribe tu nombre:</div>
            <div class="username-input-container">
              <input type="text" class="username-input" maxlength="20" placeholder="Tu nombre..." autofocus />
              <div class="username-input-buttons">
                <button class="username-btn username-btn--cancel">Cancelar</button>
                <button class="username-btn username-btn--confirm">Confirmar</button>
              </div>
            </div>
          </div>
        </div>
      `;let n=t.querySelector(`.username-input`),r=t.querySelector(`.username-btn--confirm`),i=t.querySelector(`.username-btn--cancel`),a=()=>{t.classList.remove(`active`),setTimeout(()=>t.remove(),300)};r.addEventListener(`click`,()=>{let t=n.value.trim();a(),e(t||null)}),i.addEventListener(`click`,()=>{a(),e(null)}),n.addEventListener(`keydown`,t=>{if(t.key===`Enter`){let t=n.value.trim();a(),e(t||null)}}),document.body.appendChild(t),n.focus()})}async handleCreateMonster(e){return console.log(`Creating monster:`,e),this.context.starterType=e?.type,!0}async handleCompleteQuest(){let t=await s.completeQuest(e.user.id);return t.success?(e.user.current_quest_code=t.user.current_quest_code,!0):(console.error(`Failed to complete quest:`,t),!1)}replaceVariables(t){return t.replace(/\{(\w+)\}/g,(t,n)=>this.context[n]===void 0?e.user&&e.user[n]!==void 0?e.user[n]:t:this.context[n])}},d=class extends r{constructor(){super(),this.backgroundClass=`professor-background`}async getHTML(){return i}async onEnterComplete(){await this.checkAndRunQuests()}async checkAndRunQuests(){let t=e.user;this.enterCutsceneMode(),await this.delay(500),t=await s.getUser(t.id),e.user=t;let n=t.current_quest_code;if(!n){await a.alert(`Hola de nuevo, ${t.username}! Que bueno verte por aqui.`,`Profesor Cacho`),this.exitCutsceneMode();return}let r=await s.getQuest(n);if(!r||r.scene!==`professor`){await a.alert(`Hola, ${t.username}! Vuelve cuando quieras.`,`Profesor Cacho`),this.exitCutsceneMode();return}await new u(await l(n),this).run(),this.exitCutsceneMode();let i=await s.getUser(t.id);if(e.user=i,i.current_quest_code){let e=await s.getQuest(i.current_quest_code);e&&e.scene===`professor`&&await this.checkAndRunQuests()}}async initUI(){}};export{d as ProfessorScene};