const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./EggReveal-DAKdBlKL.js","./assetRegistry-BotFMTB-.js","./EggReveal-CBOrKqUU.css"])))=>i.map(i=>d[i]);
import{a as e,c as t,f as n,i as r,l as i,o as a,r as o,s,t as c}from"./index-J6hCYXs1.js";import{t as l}from"./Scene-B1xf0tf_.js";var u=`<div class="professor">
    <div class="sprite"></div>
</div>
`,d=class e{static isActive=!1;constructor(e){this.speaker=e.speaker||``,this.text=e.text||``,this.options=e.options||[],this.onSelect=e.onSelect||(()=>{}),this.onClose=e.onClose||(()=>{}),this.typewriterSpeed=e.typewriterSpeed||30,this.enableTypewriter=e.enableTypewriter!==!1,this.closable=e.closable!==!1,this.element=null,this.textElement=null,this.typewriterTimeout=null,this.isTyping=!1,this.fullText=this.text,this.currentCharIndex=0,this.resolvePromise=null}render(){let e=document.createElement(`div`);return e.className=`message-box-overlay`,e.innerHTML=`
      <div class="message-box">
        <div class="message-box__content">
          ${this.speaker?`
            <div class="message-box__speaker">${this.speaker}</div>
          `:``}
          <div class="message-box__text"></div>
          ${this.options.length>0?`
            <div class="message-box__options">
              ${this.options.map((e,t)=>`
                <button class="message-box__option" data-index="${t}" data-value="${e.value||e.text}">
                  ${e.icon?`<span class="option-icon">${e.icon}</span>`:``}
                  <span class="option-text">${e.text}</span>
                </button>
              `).join(``)}
            </div>
          `:``}
          ${this.closable&&this.options.length===0?`
            <div class="message-box__close-hint">
              <span>Tap o [Enter] para continuar</span>
            </div>
          `:``}
        </div>
      </div>
    `,this.element=e,this.textElement=e.querySelector(`.message-box__text`),this._attachEvents(),e}_attachEvents(){this.element.querySelectorAll(`.message-box__option`).forEach(e=>{e.addEventListener(`click`,t=>{if(this.isTyping){this._skipTypewriter();return}let n=e.dataset.value,r=parseInt(e.dataset.index);this._handleSelect(n,r)})}),this.closable&&this.options.length===0&&(this.element.addEventListener(`click`,e=>{this.isTyping?this._skipTypewriter():(e.target.classList.contains(`message-box-overlay`)||e.target.closest(`.message-box__text`))&&this._handleClose()}),this._keyHandler=e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),this.isTyping?this._skipTypewriter():this._handleClose())},document.addEventListener(`keydown`,this._keyHandler)),this.textElement&&this.textElement.addEventListener(`click`,()=>{this.isTyping&&this._skipTypewriter()})}async show(){return e.isActive?new Promise(e=>e(null)):new Promise(t=>{this.resolvePromise=t,e.isActive=!0,this.element||this.render(),document.body.appendChild(this.element),requestAnimationFrame(()=>{this.element.classList.add(`active`)}),this.enableTypewriter?this._startTypewriter():(this.textElement.textContent=this.fullText,this._showOptions())})}_startTypewriter(){this.isTyping=!0,this.currentCharIndex=0,this.textElement.textContent=``;let e=()=>{this.currentCharIndex<this.fullText.length?(this.textElement.textContent+=this.fullText[this.currentCharIndex],this.currentCharIndex++,this.typewriterTimeout=setTimeout(e,this.typewriterSpeed)):(this.isTyping=!1,this._showOptions())};e()}_skipTypewriter(){this.typewriterTimeout&&clearTimeout(this.typewriterTimeout),this.isTyping=!1,this.textElement.textContent=this.fullText,this._showOptions()}_showOptions(){let e=this.element.querySelector(`.message-box__options`);e&&e.classList.add(`visible`)}_handleSelect(e,t){let n=this.options[t];this.onSelect&&this.onSelect(e,n,t),this.hide(),this.resolvePromise&&this.resolvePromise({value:e,option:n,index:t})}_handleClose(){this.onClose&&this.onClose(),this.hide(),this.resolvePromise&&this.resolvePromise(null)}hide(){e.isActive=!1,this.typewriterTimeout&&clearTimeout(this.typewriterTimeout),this._keyHandler&&document.removeEventListener(`keydown`,this._keyHandler),this.element.classList.remove(`active`),setTimeout(()=>{this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)},300)}static async show(t){return await new e(t).show()}static async alert(t,n=``){return await e.show({text:t,speaker:n,options:[],closable:!0})}static async confirm(t,n=``){let r=await e.show({text:t,speaker:n,options:[{text:`SÃ­`,value:!0},{text:`No`,value:!1}]});return r?r.value:!1}},f=`/api`;const p={async getQuests(){return(await fetch(`${f}/quests`,{headers:r()})).json()},async getQuest(e){return(await fetch(`${f}/quests/${e}`,{headers:r()})).json()},async checkUsername(e,t=null){let n=`${f}/users/check-username/${encodeURIComponent(e)}`;return t&&(n+=`?excludeUserId=${t}`),(await(await fetch(n,{headers:r()})).json()).available},async setUsername(e,t){let n=await fetch(`${f}/users/${e}/username`,{method:`PUT`,headers:r(),body:JSON.stringify({username:t})});return n.ok?{success:!0,user:await n.json()}:{success:!1,error:(await n.json()).error}},async completeQuest(e,t=0){let n=await fetch(`${f}/users/${e}/complete-quest`,{method:`POST`,headers:r(),body:JSON.stringify({delayMinutes:t})});return n.ok?{success:!0,...await n.json()}:{success:!1,error:(await n.json()).error}},async getUser(e){return(await fetch(`${f}/users/${e}`,{headers:r()})).json()}},m={egg_reveal:()=>n(()=>import(`./EggReveal-DAKdBlKL.js`),__vite__mapDeps([0,1,2]),import.meta.url)};var h=(e,t,n)=>{let r=t.lastIndexOf(`?`),i=e[r===-1||r<t.lastIndexOf(`/`)?t:t.slice(0,r)];return i?typeof i==`function`?i():Promise.resolve(i):new Promise((e,r)=>{(typeof queueMicrotask==`function`?queueMicrotask:setTimeout)(r.bind(null,Error(`Unknown variable dynamic import: `+t+(t.split(`/`).length===n?``:`. Note that variables only represent file names one level deep.`))))})};async function g(e){return(await h({"../data/quests/onboarding.json":()=>n(()=>import(`./onboarding-oIp3yrr6.js`),[],import.meta.url),"../data/quests/set_username.json":()=>n(()=>import(`./set_username-BjCYzjqk.js`),[],import.meta.url)},`../data/quests/${e}.json`,4)).default}var _=class{constructor(e,t){this.questData=e,this.dialogues=e.dialogues,this.scene=t,this.dialogueMap=new Map,this.dialogues.forEach(e=>{this.dialogueMap.set(e.id,e)}),this.context={}}async run(){let e=this.dialogues[0].id;for(;e;){let t=this.dialogueMap.get(e);if(!t){console.error(`Dialogue not found: ${e}`);break}e=await this.processDialogue(t)}}async processDialogue(e){if(e.text){let t=this.replaceVariables(e.text);if(e.options&&e.options.length>0){let n=await d.show({speaker:e.speaker,text:t,options:e.options.map(e=>({text:e.text,value:e.value,icon:e.icon}))});return n&&(e.options.find(e=>e.value===n.value)?.next||e.next)||null}else await d.alert(t,e.speaker)}if(e.action){let t=await this.handleAction(e);if(e.action===`complete_quest`)return null;if(!t)return e.next||null}return e.next||null}async handleAction(e){let t=e.action;if(m[t])try{let n=await m[t](),r=n[Object.keys(n)[0]];return await new r({runner:this,context:this.context,store:i,scene:this.scene},e.actionData).show()}catch(e){return console.error(`Error loading action "${t}":`,e),!0}switch(t){case`input_username`:return await this.handleInputUsername();case`create_monster`:return await this.handleCreateMonster(e.actionData);case`complete_quest`:return await this.handleCompleteQuest();default:return console.warn(`Unknown action: ${t}`),!0}}async handleInputUsername(){let e=null,t=!1;for(;!t;){if(e=await this.showUsernameInput(`Escribe tu nombre:`),!e)return!1;if(e.length<3){await d.alert(`El nombre debe tener al menos 3 caracteres.`,`Profesor Cacho`);continue}if(e.length>20){await d.alert(`El nombre no puede tener mas de 20 caracteres.`,`Profesor Cacho`);continue}if(!/^[a-zA-Z0-9_]+$/.test(e)){await d.alert(`El nombre solo puede contener letras, numeros y guiones bajos.`,`Profesor Cacho`);continue}if(!await p.checkUsername(e,i.user.id)){await d.alert(`Ese nombre ya esta en uso. Intenta con otro.`,`Profesor Cacho`);continue}(await p.setUsername(i.user.id,e)).success?(i.user.username=e,o.updateSession(),this.context.username=e,t=!0):await d.alert(`Hubo un error al guardar el nombre. Intenta de nuevo.`,`Profesor Cacho`)}return!0}async showUsernameInput(e=``){return new Promise(t=>{let n=i.user?.username||``,r=e?`<p class="username-input-box__text">${e}</p>`:``,a=document.createElement(`div`);a.className=`message-box-overlay message-box-overlay--centered`,a.innerHTML=`
        <div class="message-box username-input-box">
          <div class="username-input-container">
            ${r}
            <input type="text" class="input" value="${n}" maxlength="20" placeholder="Tu nombre..." />
            <button class="button">Confirmar</button>
          </div>
        </div>
      `;let o=a.querySelector(`.input`),s=a.querySelector(`.button`),c=()=>{a.classList.remove(`active`),setTimeout(()=>a.remove(),300)},l=()=>{let e=o.value.trim();e&&(c(),t(e))};s.addEventListener(`click`,l),o.addEventListener(`keydown`,e=>{e.key===`Enter`&&l()}),document.body.appendChild(a),requestAnimationFrame(()=>{a.classList.add(`active`),o.focus(),o.select()})})}async handleCreateMonster(e){return console.log(`Creating monster:`,e),this.context.starterType=e?.type,!0}parseDelay(){let e=this.questData.nextQuestDelay;if(!e)return 0;let t=this.questData.debug===!0?1:60;if(typeof e==`number`)return e*t;if(typeof e==`string`&&e.includes(`-`)){let[n,r]=e.split(`-`).map(Number),i=Math.random()*(r-n)+n;return Math.round(i*t)}return 0}async handleCompleteQuest(){let n=this.parseDelay(),r=await p.completeQuest(i.user.id,n);return r.success?(await Promise.all([t.getUserEggs(),s.getUserCandies(),a.getUserStones(),e.getUserChigos()]),i.user.current_quest_code=r.user.current_quest_code,i.user.next_quest_available_at=r.user.next_quest_available_at,i.user.gold=r.user.gold,o.updateSession(),c&&c.updateProfessorBadge(),!0):(console.error(`Failed to complete quest:`,r),!1)}async showRewards(e){let t=``;if(e.gold>0&&(t+=`+${e.gold} oro\n`),e.items?.length>0)for(let n of e.items)t+=`+${n.quantity}x ${n.name}\n`;t&&await d.alert(t.trim(),`Recompensas`)}replaceVariables(e){return e.replace(/\{(\w+)\}/g,(e,t)=>this.context[t]===void 0?i.user&&i.user[t]!==void 0?i.user[t]:e:this.context[t])}},v=class extends l{constructor(){super(),this.backgroundClass=`professor-background`}async getHTML(){return u}async onEnterComplete(){await this.checkAndRunQuests()}async checkAndRunQuests(){let e=i.user;this.enterCutsceneMode(),await this.delay(500),e=await p.getUser(e.id),i.user=e;let t=e.current_quest_code;if(!t){await d.alert(`Hola de nuevo, ${e.username}! Que bueno verte por aqui.`,`Profesor Cacho`),this.exitCutsceneMode();return}if(e.next_quest_available_at&&Math.floor(Date.now()/1e3)<e.next_quest_available_at){await d.alert(`Hola, ${e.username}! Vuelve cuando quieras.`,`Profesor Cacho`),this.exitCutsceneMode();return}let n=await p.getQuest(t);if(!n||n.scene!==`professor`){await d.alert(`Hola, ${e.username}! Vuelve cuando quieras.`,`Profesor Cacho`),this.exitCutsceneMode();return}let r=await g(t);await new _(r,this).run(),this.exitCutsceneMode();let a=r.nextQuestDelay&&r.nextQuestDelay>0;if(r.autoNextQuest!==!1&&!a){let t=await p.getUser(e.id);if(i.user=t,t.current_quest_code){let e=await p.getQuest(t.current_quest_code);e&&e.scene===`professor`&&await this.checkAndRunQuests()}}}async initUI(){}};export{v as ProfessorScene};