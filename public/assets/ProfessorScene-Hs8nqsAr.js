import{a as e,c as t,i as n,r,t as i}from"./index-BGJZ9jUx.js";import{t as a}from"./Scene-Hlsq3uGG.js";var o=`<div class="professor">
    <div class="sprite"></div>
</div>
`,s=class e{static isActive=!1;constructor(e){this.speaker=e.speaker||``,this.text=e.text||``,this.options=e.options||[],this.onSelect=e.onSelect||(()=>{}),this.onClose=e.onClose||(()=>{}),this.typewriterSpeed=e.typewriterSpeed||30,this.enableTypewriter=e.enableTypewriter!==!1,this.closable=e.closable!==!1,this.element=null,this.textElement=null,this.typewriterTimeout=null,this.isTyping=!1,this.fullText=this.text,this.currentCharIndex=0,this.resolvePromise=null}render(){let e=document.createElement(`div`);return e.className=`message-box-overlay`,e.innerHTML=`
      <div class="message-box">
        <div class="message-box__content">
          ${this.speaker?`
            <div class="message-box__speaker">${this.speaker}</div>
          `:``}
          <div class="message-box__text"></div>
          ${this.options.length>0?`
            <div class="message-box__options">
              ${this.options.map((e,t)=>`
                <button class="message-box__option" data-index="${t}" data-value="${e.value||e.text}">
                  ${e.icon?`<span class="option-icon">${e.icon}</span>`:``}
                  <span class="option-text">${e.text}</span>
                </button>
              `).join(``)}
            </div>
          `:``}
          ${this.closable&&this.options.length===0?`
            <div class="message-box__close-hint">
              <span>Tap o [Enter] para continuar</span>
            </div>
          `:``}
        </div>
      </div>
    `,this.element=e,this.textElement=e.querySelector(`.message-box__text`),this._attachEvents(),e}_attachEvents(){this.element.querySelectorAll(`.message-box__option`).forEach(e=>{e.addEventListener(`click`,t=>{if(this.isTyping){this._skipTypewriter();return}let n=e.dataset.value,r=parseInt(e.dataset.index);this._handleSelect(n,r)})}),this.closable&&this.options.length===0&&(this.element.addEventListener(`click`,e=>{this.isTyping?this._skipTypewriter():(e.target.classList.contains(`message-box-overlay`)||e.target.closest(`.message-box__text`))&&this._handleClose()}),this._keyHandler=e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),this.isTyping?this._skipTypewriter():this._handleClose())},document.addEventListener(`keydown`,this._keyHandler)),this.textElement&&this.textElement.addEventListener(`click`,()=>{this.isTyping&&this._skipTypewriter()})}async show(){return e.isActive?new Promise(e=>e(null)):new Promise(t=>{this.resolvePromise=t,e.isActive=!0,this.element||this.render(),document.body.appendChild(this.element),requestAnimationFrame(()=>{this.element.classList.add(`active`)}),this.enableTypewriter?this._startTypewriter():(this.textElement.textContent=this.fullText,this._showOptions())})}_startTypewriter(){this.isTyping=!0,this.currentCharIndex=0,this.textElement.textContent=``;let e=()=>{this.currentCharIndex<this.fullText.length?(this.textElement.textContent+=this.fullText[this.currentCharIndex],this.currentCharIndex++,this.typewriterTimeout=setTimeout(e,this.typewriterSpeed)):(this.isTyping=!1,this._showOptions())};e()}_skipTypewriter(){this.typewriterTimeout&&clearTimeout(this.typewriterTimeout),this.isTyping=!1,this.textElement.textContent=this.fullText,this._showOptions()}_showOptions(){let e=this.element.querySelector(`.message-box__options`);e&&e.classList.add(`visible`)}_handleSelect(e,t){let n=this.options[t];this.onSelect&&this.onSelect(e,n,t),this.hide(),this.resolvePromise&&this.resolvePromise({value:e,option:n,index:t})}_handleClose(){this.onClose&&this.onClose(),this.hide(),this.resolvePromise&&this.resolvePromise(null)}hide(){e.isActive=!1,this.typewriterTimeout&&clearTimeout(this.typewriterTimeout),this._keyHandler&&document.removeEventListener(`keydown`,this._keyHandler),this.element.classList.remove(`active`),setTimeout(()=>{this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)},300)}static async show(t){return await new e(t).show()}static async alert(t,n=``){return await e.show({text:t,speaker:n,options:[],closable:!0})}static async confirm(t,n=``){let r=await e.show({text:t,speaker:n,options:[{text:`SÃ­`,value:!0},{text:`No`,value:!1}]});return r?r.value:!1}},c=`/api`;const l={async getQuests(){return(await fetch(`${c}/quests`,{headers:n()})).json()},async getQuest(e){return(await fetch(`${c}/quests/${e}`,{headers:n()})).json()},async checkUsername(e,t=null){let r=`${c}/users/check-username/${encodeURIComponent(e)}`;return t&&(r+=`?excludeUserId=${t}`),(await(await fetch(r,{headers:n()})).json()).available},async setUsername(e,t){let r=await fetch(`${c}/users/${e}/username`,{method:`PUT`,headers:n(),body:JSON.stringify({username:t})});return r.ok?{success:!0,user:await r.json()}:{success:!1,error:(await r.json()).error}},async completeQuest(e,t=0){let r=await fetch(`${c}/users/${e}/complete-quest`,{method:`POST`,headers:n(),body:JSON.stringify({delayMinutes:t})});return r.ok?{success:!0,...await r.json()}:{success:!1,error:(await r.json()).error}},async getUser(e){return(await fetch(`${c}/users/${e}`,{headers:n()})).json()}};var u=(e,t,n)=>{let r=t.lastIndexOf(`?`),i=e[r===-1||r<t.lastIndexOf(`/`)?t:t.slice(0,r)];return i?typeof i==`function`?i():Promise.resolve(i):new Promise((e,r)=>{(typeof queueMicrotask==`function`?queueMicrotask:setTimeout)(r.bind(null,Error(`Unknown variable dynamic import: `+t+(t.split(`/`).length===n?``:`. Note that variables only represent file names one level deep.`))))})};async function d(e){return(await u({"../data/quests/onboarding.json":()=>t(()=>import(`./onboarding-bBFI76cr.js`),[],import.meta.url),"../data/quests/set_username.json":()=>t(()=>import(`./set_username-BjCYzjqk.js`),[],import.meta.url)},`../data/quests/${e}.json`,4)).default}var f=class{constructor(e,t){this.questData=e,this.dialogues=e.dialogues,this.scene=t,this.dialogueMap=new Map,this.dialogues.forEach(e=>{this.dialogueMap.set(e.id,e)}),this.context={}}async run(){let e=this.dialogues[0].id;for(;e;){let t=this.dialogueMap.get(e);if(!t){console.error(`Dialogue not found: ${e}`);break}e=await this.processDialogue(t)}}async processDialogue(e){if(e.text){let t=this.replaceVariables(e.text);if(e.options&&e.options.length>0){let n=await s.show({speaker:e.speaker,text:t,options:e.options.map(e=>({text:e.text,value:e.value,icon:e.icon}))});return n&&(e.options.find(e=>e.value===n.value)?.next||e.next)||null}else await s.alert(t,e.speaker)}if(e.action){let t=await this.handleAction(e);if(e.action===`complete_quest`)return null;if(!t)return e.next||null}return e.next||null}async handleAction(e){switch(e.action){case`input_username`:return await this.handleInputUsername();case`create_monster`:return await this.handleCreateMonster(e.actionData);case`complete_quest`:return await this.handleCompleteQuest();default:return console.warn(`Unknown action: ${e.action}`),!0}}async handleInputUsername(){let t=null,n=!1;for(;!n;){if(t=await this.showUsernameInput(`Escribe tu nombre:`),!t)return!1;if(t.length<3){await s.alert(`El nombre debe tener al menos 3 caracteres.`,`Profesor Cacho`);continue}if(t.length>20){await s.alert(`El nombre no puede tener mas de 20 caracteres.`,`Profesor Cacho`);continue}if(!/^[a-zA-Z0-9_]+$/.test(t)){await s.alert(`El nombre solo puede contener letras, numeros y guiones bajos.`,`Profesor Cacho`);continue}if(!await l.checkUsername(t,e.user.id)){await s.alert(`Ese nombre ya esta en uso. Intenta con otro.`,`Profesor Cacho`);continue}(await l.setUsername(e.user.id,t)).success?(e.user.username=t,r.updateSession(),this.context.username=t,n=!0):await s.alert(`Hubo un error al guardar el nombre. Intenta de nuevo.`,`Profesor Cacho`)}return!0}async showUsernameInput(t=``){return new Promise(n=>{let r=e.user?.username||``,i=t?`<p class="username-input-box__text">${t}</p>`:``,a=document.createElement(`div`);a.className=`message-box-overlay message-box-overlay--centered`,a.innerHTML=`
        <div class="message-box username-input-box">
          <div class="username-input-container">
            ${i}
            <input type="text" class="input" value="${r}" maxlength="20" placeholder="Tu nombre..." />
            <button class="button">Confirmar</button>
          </div>
        </div>
      `;let o=a.querySelector(`.input`),s=a.querySelector(`.button`),c=()=>{a.classList.remove(`active`),setTimeout(()=>a.remove(),300)},l=()=>{let e=o.value.trim();e&&(c(),n(e))};s.addEventListener(`click`,l),o.addEventListener(`keydown`,e=>{e.key===`Enter`&&l()}),document.body.appendChild(a),requestAnimationFrame(()=>{a.classList.add(`active`),o.focus(),o.select()})})}async handleCreateMonster(e){return console.log(`Creating monster:`,e),this.context.starterType=e?.type,!0}parseDelay(){let e=this.questData.nextQuestDelay;if(!e)return 0;let t=this.questData.debug===!0?1:60;if(typeof e==`number`)return e*t;if(typeof e==`string`&&e.includes(`-`)){let[n,r]=e.split(`-`).map(Number),i=Math.random()*(r-n)+n;return Math.round(i*t)}return 0}async handleCompleteQuest(){let t=this.parseDelay(),n=await l.completeQuest(e.user.id,t);return n.success?(e.user.current_quest_code=n.user.current_quest_code,e.user.next_quest_available_at=n.user.next_quest_available_at,r.updateSession(),i&&i.updateProfessorBadge(),!0):(console.error(`Failed to complete quest:`,n),!1)}replaceVariables(t){return t.replace(/\{(\w+)\}/g,(t,n)=>this.context[n]===void 0?e.user&&e.user[n]!==void 0?e.user[n]:t:this.context[n])}},p=class extends a{constructor(){super(),this.backgroundClass=`professor-background`}async getHTML(){return o}async onEnterComplete(){await this.checkAndRunQuests()}async checkAndRunQuests(){let t=e.user;this.enterCutsceneMode(),await this.delay(500),t=await l.getUser(t.id),e.user=t;let n=t.current_quest_code;if(!n){await s.alert(`Hola de nuevo, ${t.username}! Que bueno verte por aqui.`,`Profesor Cacho`),this.exitCutsceneMode();return}if(t.next_quest_available_at&&Math.floor(Date.now()/1e3)<t.next_quest_available_at){await s.alert(`Hola, ${t.username}! Vuelve cuando quieras.`,`Profesor Cacho`),this.exitCutsceneMode();return}let r=await l.getQuest(n);if(!r||r.scene!==`professor`){await s.alert(`Hola, ${t.username}! Vuelve cuando quieras.`,`Profesor Cacho`),this.exitCutsceneMode();return}let i=await d(n);await new f(i,this).run(),this.exitCutsceneMode();let a=i.nextQuestDelay&&i.nextQuestDelay>0;if(i.autoNextQuest!==!1&&!a){let n=await l.getUser(t.id);if(e.user=n,n.current_quest_code){let e=await l.getQuest(n.current_quest_code);e&&e.scene===`professor`&&await this.checkAndRunQuests()}}}async initUI(){}};export{p as ProfessorScene};